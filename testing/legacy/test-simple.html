<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RichMan ç°¡å–®æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.connecting {
            background: #fff3cd;
            color: #856404;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® RichMan ç°¡å–®é€£æ¥æ¸¬è©¦</h1>
        
        <div id="status" class="status connecting">
            ğŸ”Œ æº–å‚™é€£æ¥...
        </div>
        
        <div>
            <button onclick="testBasicFunction()">æ¸¬è©¦åŸºæœ¬åŠŸèƒ½</button>
            <button onclick="connectToServer()">é€£æ¥ä¼ºæœå™¨</button>
            <button onclick="findWindowsIP()">æŸ¥æ‰¾Windows IP</button>
            <button onclick="scanAllIPs()">æƒææ‰€æœ‰IP</button>
            <button onclick="connectWithIP()">ä½¿ç”¨IPé€£æ¥</button>
            <button onclick="testConnection()">æ¸¬è©¦é€£æ¥</button>
            <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
        </div>
        
        <div style="margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 5px;">
            <strong>ğŸ”§ ç¶²è·¯é…ç½®æª¢æ¸¬ï¼š</strong><br>
            â€¢ é›»è…¦ä¸»è¦IPï¼š<span style="color: red; font-weight: bold;">192.168.117.202</span><br>
            â€¢ é›»è…¦WSL IPï¼š<span style="color: blue;">172.28.96.1</span><br>
            â€¢ ç¶²è·¯é¡å‹ï¼š<span style="color: orange;">æ‰‹æ©Ÿç†±é»åˆ†äº«çµ¦é›»è…¦</span><br>
            â€¢ å»ºè­°IPï¼š<span style="color: green;">192.168.117.202</span>
        </div>
        
        <div style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 5px;">
            <strong>âš ï¸ ç‰¹æ®Šç¶²è·¯é…ç½®èªªæ˜ï¼š</strong><br>
            ç”±æ–¼é›»è…¦ä½¿ç”¨æ‰‹æ©Ÿåˆ†äº«çš„ç¶²è·¯ï¼Œéœ€è¦ç‰¹æ®Šè¨­å®šã€‚è«‹å˜—è©¦ä»¥ä¸‹æ–¹æ³•ï¼š<br>
            1. <strong>é›»è…¦ç‰ˆ</strong>ï¼šç›´æ¥ä½¿ç”¨localhost<br>
            2. <strong>æ‰‹æ©Ÿç‰ˆ</strong>ï¼šéœ€è¦æ‰¾åˆ°Windowsä¸»æ©Ÿçš„å¯¦éš›IP
        </div>
        
        <div id="log" class="log">
            <div>[ç³»çµ±] é é¢è¼‰å…¥å®Œæˆ</div>
        </div>
    </div>

    <!-- Socket.IO å®¢æˆ¶ç«¯ -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        let socket = null;
        let logEl = document.getElementById('log');
        let statusEl = document.getElementById('status');
        
        // åŸºæœ¬æ—¥èªŒåŠŸèƒ½
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEl.appendChild(logEntry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        // æ›´æ–°ç‹€æ…‹
        function updateStatus(message, type) {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        // æ¸…é™¤æ—¥èªŒ
        function clearLog() {
            logEl.innerHTML = '<div>[ç³»çµ±] æ—¥èªŒå·²æ¸…é™¤</div>';
        }
        
        // æ¸¬è©¦åŸºæœ¬åŠŸèƒ½
        function testBasicFunction() {
            addLog('âœ… åŸºæœ¬åŠŸèƒ½æ¸¬è©¦ - æŒ‰éˆ•é»æ“Šæ­£å¸¸ï¼');
            addLog('ğŸ“Š Window location: ' + window.location.href);
            addLog('ğŸŒ Protocol: ' + window.location.protocol);
            
            if (typeof io !== 'undefined') {
                addLog('âœ… Socket.IO å·²è¼‰å…¥ï¼Œç‰ˆæœ¬: ' + (io.version || 'unknown'));
            } else {
                addLog('âŒ Socket.IO æœªè¼‰å…¥ï¼');
            }
        }
        
        // é€£æ¥åˆ°ä¼ºæœå™¨
        function connectToServer() {
            addLog('ğŸ”Œ é–‹å§‹é€£æ¥åˆ°ä¼ºæœå™¨...');
            
            if (typeof io === 'undefined') {
                addLog('âŒ Socket.IO æœªè¼‰å…¥ï¼Œç„¡æ³•é€£æ¥');
                updateStatus('âŒ Socket.IO è¼‰å…¥å¤±æ•—', 'error');
                return;
            }
            
            // æ™ºèƒ½æª¢æ¸¬ä¼ºæœå™¨åœ°å€
            let serverURL = 'http://localhost:5000';
            
            // å¦‚æœæ˜¯æ‰‹æ©Ÿè¨ªå•ï¼Œéœ€è¦è¼¸å…¥é›»è…¦IP
            if (window.location.protocol === 'file:') {
                const savedIP = localStorage.getItem('richman_server_ip');
                
                if (savedIP) {
                    const useStored = confirm(`ä½¿ç”¨å„²å­˜çš„IP: ${savedIP}:5000?\nç¢ºå®š=ä½¿ç”¨\nå–æ¶ˆ=é‡æ–°è¼¸å…¥`);
                    if (useStored) {
                        serverURL = `http://${savedIP}:5000`;
                    } else {
                        const newIP = prompt('è«‹è¼¸å…¥é›»è…¦çš„IPåœ°å€:', savedIP);
                        if (newIP && newIP.trim()) {
                            localStorage.setItem('richman_server_ip', newIP.trim());
                            serverURL = `http://${newIP.trim()}:5000`;
                        }
                    }
                } else {
                    // ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè©¢å•æ˜¯å¦éœ€è¦è¼¸å…¥IP
                    const needIP = confirm('æª¢æ¸¬åˆ°æœ¬åœ°æ–‡ä»¶è¨ªå•ã€‚\nå¦‚æœåœ¨æ‰‹æ©Ÿä¸Šï¼Œéœ€è¦è¼¸å…¥é›»è…¦IPã€‚\nå¦‚æœåœ¨é›»è…¦ä¸Šï¼Œç›´æ¥ä½¿ç”¨localhostã€‚\n\né»ç¢ºå®šè¼¸å…¥é›»è…¦IPï¼Œå–æ¶ˆä½¿ç”¨localhost');
                    
                    if (needIP) {
                        const computerIP = prompt('è«‹è¼¸å…¥é›»è…¦çš„WiFi IPåœ°å€\n(åœ¨é›»è…¦cmdåŸ·è¡ŒipconfigæŸ¥çœ‹):', '192.168.1.');
                        if (computerIP && computerIP.trim()) {
                            localStorage.setItem('richman_server_ip', computerIP.trim());
                            serverURL = `http://${computerIP.trim()}:5000`;
                        }
                    }
                }
            }
            
            addLog('ğŸ“¡ å˜—è©¦é€£æ¥åˆ°: ' + serverURL);
            
            try {
                // æ–·é–‹èˆŠé€£æ¥
                if (socket) {
                    socket.disconnect();
                }
                
                socket = io(serverURL, {
                    transports: ['polling', 'websocket'],
                    timeout: 10000,
                    forceNew: true
                });
                
                setupSocketEvents();
                updateStatus('ğŸŸ¡ é€£æ¥ä¸­...', 'connecting');
                
            } catch (error) {
                addLog('âŒ å‰µå»ºSocketæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                updateStatus('âŒ é€£æ¥å¤±æ•—', 'error');
            }
        }
        
        // æƒææ‰€æœ‰å¯èƒ½çš„IP (æ‰‹æ©Ÿç†±é»å°ˆç”¨)
        function scanAllIPs() {
            addLog('ğŸ” é–‹å§‹æƒææ‰‹æ©Ÿç†±é»ç¶²è·¯ä¸­çš„æ‰€æœ‰å¯èƒ½IP...', 'info');
            
            const hotspotIPs = [
                '192.168.117.202', // é›»è…¦å¯¦éš›æª¢æ¸¬åˆ°çš„IP (å„ªå…ˆæ¸¬è©¦)
                '172.28.96.1',     // WSLç¶²è·¯ä»‹é¢IP
                '192.168.137.1',   // æ‰‹æ©Ÿç†±é»ä¸»æ©Ÿ
                '192.168.137.2',   // é›»è…¦å¯èƒ½çš„IP
                '192.168.43.1',    // Androidç†±é»
                '192.168.43.2',    // Androidç†±é»å®¢æˆ¶ç«¯
                '172.20.10.1',     // iPhoneç†±é»
            ];
            
            addLog('ğŸ“± æ‰‹æ©Ÿç†±é»ç¶²è·¯æƒæåˆ—è¡¨:', 'info');
            hotspotIPs.forEach((ip, index) => {
                addLog(`${index + 1}. ${ip}`, 'info');
            });
            
            if (confirm('é–‹å§‹è‡ªå‹•æƒæï¼Ÿé€™æœƒä¾åºæ¸¬è©¦æ‰€æœ‰IPåœ°å€')) {
                scanIPsSequentially(hotspotIPs, 0);
            }
        }
        
        // ä¾åºæƒæIPåœ°å€
        function scanIPsSequentially(ips, index) {
            if (index >= ips.length) {
                addLog('âŒ æ‰€æœ‰IPæƒæå®Œæˆï¼Œæœªæ‰¾åˆ°å¯ç”¨çš„ä¼ºæœå™¨', 'error');
                addLog('ğŸ’¡ å»ºè­°æª¢æŸ¥:', 'info');
                addLog('1. ç¢ºèªé›»è…¦ä¼ºæœå™¨æ­£åœ¨é‹è¡Œ', 'info');
                addLog('2. ç¢ºèªé˜²ç«ç‰†è¨­å®š', 'info');
                addLog('3. å˜—è©¦åœ¨é›»è…¦ç«¯åŸ·è¡Œ find-ip.bat æŸ¥çœ‹å¯¦éš›IP', 'info');
                return;
            }
            
            const ip = ips[index];
            addLog(`ğŸ” æ­£åœ¨æ¸¬è©¦ ${ip}...`, 'info');
            
            // å‰µå»ºæ¸¬è©¦é€£æ¥
            const testSocket = io(`http://${ip}:5000`, {
                transports: ['polling'],
                timeout: 5000,
                forceNew: true
            });
            
            testSocket.on('connect', () => {
                addLog(`âœ… æ‰¾åˆ°å¯ç”¨IP: ${ip}`, 'success');
                testSocket.disconnect();
                
                // ä½¿ç”¨æ‰¾åˆ°çš„IPé€²è¡Œæ­£å¼é€£æ¥
                if (confirm(`ç™¼ç¾å¯ç”¨ä¼ºæœå™¨ ${ip}:5000ï¼Œè¦é€£æ¥å—ï¼Ÿ`)) {
                    localStorage.setItem('richman_server_ip', ip);
                    connectWithSpecificIP(ip);
                }
            });
            
            testSocket.on('connect_error', () => {
                addLog(`âŒ ${ip} ç„¡æ³•é€£æ¥`, 'error');
                testSocket.disconnect();
                
                // æ¸¬è©¦ä¸‹ä¸€å€‹IP
                setTimeout(() => {
                    scanIPsSequentially(ips, index + 1);
                }, 1000);
            });
        }
        
        // æŸ¥æ‰¾Windowsä¸»æ©ŸIP (ç°¡åŒ–ç‰ˆ)
        function findWindowsIP() {
            addLog('ğŸ” æ‰‹æ©Ÿç†±é»ç¶²è·¯é…ç½®èªªæ˜...', 'info');
            addLog('ğŸ“± ä½ çš„æ‰‹æ©Ÿé–‹å•Ÿç†±é»çµ¦é›»è…¦ä½¿ç”¨', 'info');
            addLog('ğŸ–¥ï¸ åœ¨é€™ç¨®é…ç½®ä¸‹ï¼š', 'info');
            addLog('â€¢ æ‰‹æ©ŸIPé€šå¸¸æ˜¯: 192.168.137.1', 'info');
            addLog('â€¢ é›»è…¦IPé€šå¸¸æ˜¯: 192.168.137.2 æˆ–å…¶ä»–', 'info');
            addLog('â€¢ ä¼ºæœå™¨é‹è¡Œåœ¨é›»è…¦ä¸Šï¼Œæ‰€ä»¥è¦é€£æ¥é›»è…¦çš„IP', 'info');
            
            addLog('ğŸ’¡ å»ºè­°åŸ·è¡Œã€Œæƒææ‰€æœ‰IPã€ä¾†è‡ªå‹•æŸ¥æ‰¾', 'info');
        }
        
        // ä½¿ç”¨ç‰¹å®šIPé€£æ¥
        function connectWithSpecificIP(ip) {
            const serverURL = `http://${ip}:5000`;
            addLog(`ğŸ”— è‡ªå‹•æ¸¬è©¦é€£æ¥åˆ°: ${serverURL}`, 'info');
            
            try {
                if (socket) {
                    socket.disconnect();
                }
                
                socket = io(serverURL, {
                    transports: ['polling', 'websocket'],
                    timeout: 8000,  // è¼ƒçŸ­çš„è¶…æ™‚æ™‚é–“ç”¨æ–¼å¿«é€Ÿæ¸¬è©¦
                    forceNew: true
                });
                
                setupSocketEvents();
                updateStatus('ğŸŸ¡ æ¸¬è©¦é€£æ¥ä¸­...', 'connecting');
                
                // è¨­ç½®æ¸¬è©¦è¶…æ™‚
                setTimeout(() => {
                    if (!socket.connected) {
                        addLog(`âŒ ${ip} é€£æ¥å¤±æ•—ï¼Œè«‹å˜—è©¦å…¶ä»–IP`, 'error');
                        socket.disconnect();
                    }
                }, 8000);
                
            } catch (error) {
                addLog('âŒ æ¸¬è©¦é€£æ¥æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
            }
        }
        
        // ä½¿ç”¨IPé€£æ¥ (æ‰‹æ©Ÿç‰ˆ)
        function connectWithIP() {
            const savedIP = localStorage.getItem('richman_server_ip');
            const defaultIP = savedIP || '192.168.117.202';
            
            const ip = prompt(`è«‹è¼¸å…¥Windowsä¸»æ©ŸIPåœ°å€:
            
æª¢æ¸¬åˆ°çš„IP:
â€¢ 192.168.117.202 (ä¸»è¦IPï¼Œå»ºè­°å„ªå…ˆæ¸¬è©¦)
â€¢ 172.28.96.1 (WSL IP)

å…¶ä»–å¸¸è¦‹IP:
â€¢ 192.168.137.1 (Windowsåˆ†äº«)
â€¢ 192.168.43.1 (Androidåˆ†äº«)`, defaultIP);
            
            if (!ip || !ip.trim()) {
                addLog('âŒ æœªè¼¸å…¥IPåœ°å€');
                return;
            }
            
            const serverURL = `http://${ip.trim()}:5000`;
            addLog('ğŸ“± æ‰‹æ©Ÿç‰ˆé€£æ¥æ¨¡å¼');
            addLog('ğŸ“¡ å˜—è©¦é€£æ¥åˆ°: ' + serverURL);
            
            // å„²å­˜IPä¾›ä¸‹æ¬¡ä½¿ç”¨
            localStorage.setItem('richman_server_ip', ip.trim());
            
            try {
                // æ–·é–‹èˆŠé€£æ¥
                if (socket) {
                    socket.disconnect();
                }
                
                socket = io(serverURL, {
                    transports: ['polling', 'websocket'],
                    timeout: 15000,
                    forceNew: true
                });
                
                setupSocketEvents();
                updateStatus('ğŸŸ¡ é€£æ¥ä¸­...', 'connecting');
                
            } catch (error) {
                addLog('âŒ å‰µå»ºSocketæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                updateStatus('âŒ é€£æ¥å¤±æ•—', 'error');
            }
        }
        
        // è¨­ç½®Socketäº‹ä»¶
        function setupSocketEvents() {
            socket.on('connect', () => {
                addLog('âœ… é€£æ¥æˆåŠŸï¼Socket ID: ' + socket.id);
                updateStatus('ğŸŸ¢ å·²é€£æ¥', 'connected');
            });
            
            socket.on('connect_error', (error) => {
                addLog('âŒ é€£æ¥éŒ¯èª¤: ' + (error.message || error.type || error));
                addLog('ğŸ”§ éŒ¯èª¤è©³æƒ…: ' + JSON.stringify(error));
                updateStatus('ğŸ”´ é€£æ¥å¤±æ•—', 'error');
                
                // æä¾›è¨ºæ–·è³‡è¨Š
                setTimeout(() => {
                    addLog('ğŸ“‹ æ‰‹æ©Ÿé€£æ¥è¨ºæ–·:');
                    addLog('1. ç¢ºä¿æ‰‹æ©Ÿå’Œé›»è…¦åœ¨åŒä¸€WiFiç¶²è·¯');
                    addLog('2. ç¢ºä¿Windowsé˜²ç«ç‰†å…è¨±5000ç«¯å£');
                    addLog('3. ç¢ºä¿ä¼ºæœå™¨æ­£åœ¨é‹è¡Œ');
                    addLog('4. å˜—è©¦ä¸åŒçš„IPåœ°å€');
                }, 1000);
            });
            
            socket.on('disconnect', (reason) => {
                addLog('âŒ é€£æ¥ä¸­æ–·: ' + reason);
                updateStatus('ğŸŸ¡ é€£æ¥ä¸­æ–·', 'error');
            });
            
            // Ping/Pongæ¸¬è©¦
            socket.on('pong', (data) => {
                addLog('ğŸ“ æ”¶åˆ°Pongå›æ‡‰ï¼å»¶é²: ' + (Date.now() - data.timestamp) + 'ms');
            });
        }
        
        // æ¸¬è©¦é€£æ¥
        function testConnection() {
            if (!socket) {
                addLog('âŒ æœªå»ºç«‹é€£æ¥ï¼Œè«‹å…ˆé€£æ¥ä¼ºæœå™¨');
                return;
            }
            
            if (socket.connected) {
                addLog('ğŸ“ ç™¼é€Pingæ¸¬è©¦...');
                socket.emit('ping', { timestamp: Date.now() });
            } else {
                addLog('âŒ Socketæœªé€£æ¥');
            }
        }
        
        // é é¢è¼‰å…¥å®Œæˆ
        window.onload = function() {
            addLog('ğŸš€ é é¢åˆå§‹åŒ–å®Œæˆ');
            testBasicFunction();
        };
        
        // éŒ¯èª¤è™•ç†
        window.onerror = function(msg, url, line, col, error) {
            addLog('âŒ JavaScriptéŒ¯èª¤: ' + msg + ' (è¡Œ:' + line + ')');
            return false;
        };
    </script>
</body>
</html>